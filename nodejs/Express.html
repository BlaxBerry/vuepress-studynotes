<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Express基础 | StudyNotes</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="Program Study Notes">
    
    <link rel="preload" href="/vuepress-studynotes/assets/css/0.styles.76fe6966.css" as="style"><link rel="preload" href="/vuepress-studynotes/assets/js/app.5828a084.js" as="script"><link rel="preload" href="/vuepress-studynotes/assets/js/2.d9925a17.js" as="script"><link rel="preload" href="/vuepress-studynotes/assets/js/19.cd17f587.js" as="script"><link rel="prefetch" href="/vuepress-studynotes/assets/js/10.62c97a0f.js"><link rel="prefetch" href="/vuepress-studynotes/assets/js/11.ff9fed4e.js"><link rel="prefetch" href="/vuepress-studynotes/assets/js/12.3dd9c52a.js"><link rel="prefetch" href="/vuepress-studynotes/assets/js/13.c9a18407.js"><link rel="prefetch" href="/vuepress-studynotes/assets/js/14.d74c9ee3.js"><link rel="prefetch" href="/vuepress-studynotes/assets/js/15.8a51b5ec.js"><link rel="prefetch" href="/vuepress-studynotes/assets/js/16.8059d87b.js"><link rel="prefetch" href="/vuepress-studynotes/assets/js/17.1dea73c4.js"><link rel="prefetch" href="/vuepress-studynotes/assets/js/18.8cef3938.js"><link rel="prefetch" href="/vuepress-studynotes/assets/js/20.bdb09277.js"><link rel="prefetch" href="/vuepress-studynotes/assets/js/21.9f287ea7.js"><link rel="prefetch" href="/vuepress-studynotes/assets/js/22.ef1dfd87.js"><link rel="prefetch" href="/vuepress-studynotes/assets/js/23.7e5fc990.js"><link rel="prefetch" href="/vuepress-studynotes/assets/js/24.6bbc76f4.js"><link rel="prefetch" href="/vuepress-studynotes/assets/js/25.edc2689f.js"><link rel="prefetch" href="/vuepress-studynotes/assets/js/26.d990c5b1.js"><link rel="prefetch" href="/vuepress-studynotes/assets/js/27.8014432f.js"><link rel="prefetch" href="/vuepress-studynotes/assets/js/28.410ae66b.js"><link rel="prefetch" href="/vuepress-studynotes/assets/js/29.376a08a0.js"><link rel="prefetch" href="/vuepress-studynotes/assets/js/3.67154149.js"><link rel="prefetch" href="/vuepress-studynotes/assets/js/4.e28d95fe.js"><link rel="prefetch" href="/vuepress-studynotes/assets/js/5.a2e95fe6.js"><link rel="prefetch" href="/vuepress-studynotes/assets/js/6.aaa3c0da.js"><link rel="prefetch" href="/vuepress-studynotes/assets/js/7.ff167ccc.js"><link rel="prefetch" href="/vuepress-studynotes/assets/js/8.a1406bec.js"><link rel="prefetch" href="/vuepress-studynotes/assets/js/9.66d6c23b.js">
    <link rel="stylesheet" href="/vuepress-studynotes/assets/css/0.styles.76fe6966.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/vuepress-studynotes/" class="home-link router-link-active"><!----> <span class="site-name">StudyNotes</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/vuepress-studynotes/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/vuepress-studynotes/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Front-End" class="dropdown-title"><span class="title">Front-End</span> <span class="arrow down"></span></button> <button type="button" aria-label="Front-End" class="mobile-dropdown-title"><span class="title">Front-End</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          Vue.js
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vuepress-studynotes/vue/Vue2+Vue-Cli.html" class="nav-link">
  Vue 2
</a></li><li class="dropdown-subitem"><a href="/vuepress-studynotes/vue/Vue2+Vue-Router.html" class="nav-link">
  Vue-Router
</a></li><li class="dropdown-subitem"><a href="/vuepress-studynotes/vue/Vue2+Vuex.html" class="nav-link">
  Vuex
</a></li><li class="dropdown-subitem"><a href="/vuepress-studynotes/vue/Vue3+Vue-cli.html" class="nav-link">
  Vue 3
</a></li></ul></li><li class="dropdown-item"><h4>
          React.js
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vuepress-studynotes/react/React-Basic.html" class="nav-link">
  React
</a></li><li class="dropdown-subitem"><a href="/vuepress-studynotes/react/React-Router.m.html" class="nav-link">
  React-Router-Dom
</a></li><li class="dropdown-subitem"><a href="/vuepress-studynotes/react/React-Components.html" class="nav-link">
  Redux
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Links" class="dropdown-title"><span class="title">Links</span> <span class="arrow down"></span></button> <button type="button" aria-label="Links" class="mobile-dropdown-title"><span class="title">Links</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/BlaxBerry" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://blaxberry.github.io/#/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Portfolio
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/vuepress-studynotes/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/vuepress-studynotes/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Front-End" class="dropdown-title"><span class="title">Front-End</span> <span class="arrow down"></span></button> <button type="button" aria-label="Front-End" class="mobile-dropdown-title"><span class="title">Front-End</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          Vue.js
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vuepress-studynotes/vue/Vue2+Vue-Cli.html" class="nav-link">
  Vue 2
</a></li><li class="dropdown-subitem"><a href="/vuepress-studynotes/vue/Vue2+Vue-Router.html" class="nav-link">
  Vue-Router
</a></li><li class="dropdown-subitem"><a href="/vuepress-studynotes/vue/Vue2+Vuex.html" class="nav-link">
  Vuex
</a></li><li class="dropdown-subitem"><a href="/vuepress-studynotes/vue/Vue3+Vue-cli.html" class="nav-link">
  Vue 3
</a></li></ul></li><li class="dropdown-item"><h4>
          React.js
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/vuepress-studynotes/react/React-Basic.html" class="nav-link">
  React
</a></li><li class="dropdown-subitem"><a href="/vuepress-studynotes/react/React-Router.m.html" class="nav-link">
  React-Router-Dom
</a></li><li class="dropdown-subitem"><a href="/vuepress-studynotes/react/React-Components.html" class="nav-link">
  Redux
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Links" class="dropdown-title"><span class="title">Links</span> <span class="arrow down"></span></button> <button type="button" aria-label="Links" class="mobile-dropdown-title"><span class="title">Links</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/BlaxBerry" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://blaxberry.github.io/#/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Portfolio
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Express基础</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vuepress-studynotes/nodejs/Express.html#简介" class="sidebar-link">简介</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/vuepress-studynotes/nodejs/Express.html#安装" class="sidebar-link">安装</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/vuepress-studynotes/nodejs/Express.html#基础使用" class="sidebar-link">基础使用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuepress-studynotes/nodejs/Express.html#创建基础web服务器" class="sidebar-link">创建基础Web服务器</a></li><li class="sidebar-sub-header"><a href="/vuepress-studynotes/nodejs/Express.html#监听get请求" class="sidebar-link">监听GET请求</a></li><li class="sidebar-sub-header"><a href="/vuepress-studynotes/nodejs/Express.html#监听post请求" class="sidebar-link">监听POST请求</a></li><li class="sidebar-sub-header"><a href="/vuepress-studynotes/nodejs/Express.html#req请求对象" class="sidebar-link">req请求对象</a></li><li class="sidebar-sub-header"><a href="/vuepress-studynotes/nodejs/Express.html#res响应对象" class="sidebar-link">res响应对象</a></li></ul></li><li><a href="/vuepress-studynotes/nodejs/Express.html#托管静态资源" class="sidebar-link">托管静态资源</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuepress-studynotes/nodejs/Express.html#express-static" class="sidebar-link">express.static()</a></li><li class="sidebar-sub-header"><a href="/vuepress-studynotes/nodejs/Express.html#托管多个静态资源目录" class="sidebar-link">托管多个静态资源目录</a></li><li class="sidebar-sub-header"><a href="/vuepress-studynotes/nodejs/Express.html#静态资源路径添加前缀" class="sidebar-link">静态资源路径添加前缀</a></li></ul></li><li><a href="/vuepress-studynotes/nodejs/Express.html#express路由" class="sidebar-link">Express路由</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuepress-studynotes/nodejs/Express.html#概念" class="sidebar-link">概念</a></li><li class="sidebar-sub-header"><a href="/vuepress-studynotes/nodejs/Express.html#路由匹配过程" class="sidebar-link">路由匹配过程</a></li><li class="sidebar-sub-header"><a href="/vuepress-studynotes/nodejs/Express.html#基础路由" class="sidebar-link">基础路由</a></li><li class="sidebar-sub-header"><a href="/vuepress-studynotes/nodejs/Express.html#模块化路由" class="sidebar-link">模块化路由</a></li><li class="sidebar-sub-header"><a href="/vuepress-studynotes/nodejs/Express.html#路由模块添加前缀" class="sidebar-link">路由模块添加前缀</a></li><li class="sidebar-sub-header"><a href="/vuepress-studynotes/nodejs/Express.html#路由参数" class="sidebar-link">路由参数</a></li><li class="sidebar-sub-header"><a href="/vuepress-studynotes/nodejs/Express.html#路由重定向" class="sidebar-link">路由重定向</a></li><li class="sidebar-sub-header"><a href="/vuepress-studynotes/nodejs/Express.html#路由拦截-登陆拦截" class="sidebar-link">路由拦截/登陆拦截</a></li></ul></li><li><a href="/vuepress-studynotes/nodejs/Express.html#express中间件" class="sidebar-link">Express中间件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuepress-studynotes/nodejs/Express.html#基础概念" class="sidebar-link">基础概念</a></li><li class="sidebar-sub-header"><a href="/vuepress-studynotes/nodejs/Express.html#中间件注意点" class="sidebar-link">中间件注意点</a></li><li class="sidebar-sub-header"><a href="/vuepress-studynotes/nodejs/Express.html#全局生效中间件" class="sidebar-link">全局生效中间件</a></li><li class="sidebar-sub-header"><a href="/vuepress-studynotes/nodejs/Express.html#局部生效中间件" class="sidebar-link">局部生效中间件</a></li><li class="sidebar-sub-header"><a href="/vuepress-studynotes/nodejs/Express.html#中间件分类" class="sidebar-link">中间件分类</a></li><li class="sidebar-sub-header"><a href="/vuepress-studynotes/nodejs/Express.html#解析请求体数据格式的中间件" class="sidebar-link">解析请求体数据格式的中间件</a></li><li class="sidebar-sub-header"><a href="/vuepress-studynotes/nodejs/Express.html#自定义中间件" class="sidebar-link">自定义中间件</a></li><li class="sidebar-sub-header"><a href="/vuepress-studynotes/nodejs/Express.html#捕获错误" class="sidebar-link">捕获错误</a></li></ul></li><li><a href="/vuepress-studynotes/nodejs/Express.html#请求参数" class="sidebar-link">请求参数</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuepress-studynotes/nodejs/Express.html#传递" class="sidebar-link">传递</a></li><li class="sidebar-sub-header"><a href="/vuepress-studynotes/nodejs/Express.html#接收" class="sidebar-link">接收</a></li></ul></li><li><a href="/vuepress-studynotes/nodejs/Express.html#express写接口" class="sidebar-link">Express写接口</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/vuepress-studynotes/nodejs/Express.html#通过express写接口" class="sidebar-link">通过Express写接口</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuepress-studynotes/nodejs/Express.html#cors-跨域资源共享" class="sidebar-link">CORS（跨域资源共享）</a></li><li class="sidebar-sub-header"><a href="/vuepress-studynotes/nodejs/Express.html#jsonp接口" class="sidebar-link">JSONP接口</a></li></ul></li><li><a href="/vuepress-studynotes/nodejs/Express.html#模版引擎-express-art-template" class="sidebar-link">模版引擎 express-art-template</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuepress-studynotes/nodejs/Express.html#基础设置" class="sidebar-link">基础设置</a></li><li class="sidebar-sub-header"><a href="/vuepress-studynotes/nodejs/Express.html#app-locals对象" class="sidebar-link">app.locals对象</a></li><li class="sidebar-sub-header"><a href="/vuepress-studynotes/nodejs/Express.html#模版中的外链资源路径" class="sidebar-link">模版中的外链资源路径</a></li></ul></li><li><a href="/vuepress-studynotes/nodejs/Express.html#密码加密-bcrypt" class="sidebar-link">密码加密 bcrypt</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuepress-studynotes/nodejs/Express.html#导入、加密" class="sidebar-link">导入、加密</a></li><li class="sidebar-sub-header"><a href="/vuepress-studynotes/nodejs/Express.html#密码比对" class="sidebar-link">密码比对</a></li></ul></li><li><a href="/vuepress-studynotes/nodejs/Express.html#身份认证" class="sidebar-link">身份认证</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuepress-studynotes/nodejs/Express.html#session认证" class="sidebar-link">Session认证</a></li><li class="sidebar-sub-header"><a href="/vuepress-studynotes/nodejs/Express.html#jwt认证" class="sidebar-link">JWT认证</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="express基础"><a href="#express基础" class="header-anchor">#</a> Express基础</h1> <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--tzFy8l83--/c_imagga_scale,f_auto,fl_progressive,h_900,q_auto,w_1600/https://dev-to-uploads.s3.amazonaws.com/i/1stt4h63pbbb79pjzuf6.png" style="zoom:50%;"> <h2 id="简介"><a href="#简介" class="header-anchor">#</a> 简介</h2> <p>Express是一个基于Node.js 的快速简易的<strong>Web开发框架</strong></p> <p>基于Node.js内置的http模块封装，更方便强大</p> <p>可用于创建：</p> <ul><li><p><strong>Web网站服务器</strong></p></li> <li><p><strong>API接口服务器</strong></p></li></ul> <h2 id="安装"><a href="#安装" class="header-anchor">#</a> 安装</h2> <p>本笔记使用的是4.17.1版本</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> i express@4.17.1
</code></pre></div><h2 id="基础使用"><a href="#基础使用" class="header-anchor">#</a> 基础使用</h2> <h3 id="创建基础web服务器"><a href="#创建基础web服务器" class="header-anchor">#</a> 创建基础Web服务器</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 1. 导入 express</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>

<span class="token comment">// 2. 创建web 服务器</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 3. 监听端口，启动服务器</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Server Running at localhost:3000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="监听get请求"><a href="#监听get请求" class="header-anchor">#</a> 监听GET请求</h3> <p>通过<strong>get()</strong> 方法，监听客户端发送来的GET请求</p> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'请求的URL地址'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token comment">// req: 请求对象</span>
  <span class="token comment">// res：响应对象</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="监听post请求"><a href="#监听post请求" class="header-anchor">#</a> 监听POST请求</h3> <p>通过<strong>post()</strong> 方法，监听客户端发送来的POST请求</p> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'请求的URL地址'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token comment">// req: 请求对象</span>
  <span class="token comment">// res：响应对象</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="req请求对象"><a href="#req请求对象" class="header-anchor">#</a> req请求对象</h3> <p>包含与请求相关的数据和属性</p> <hr> <h4 id="req-query"><a href="#req-query" class="header-anchor">#</a> req.query</h4> <p>Express增加的属性，</p> <p>不再需要和原本Nod.js一样还要引用url模块来处理请求URL了</p> <p>可获取请求URL中<strong>查询字符串</strong>的形式 <strong>GET请求参数</strong></p> <p>即，key=value&amp;key=value形式的GET参数</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>


app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/get'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>query<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>


app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Server Running at localhost:3000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>以JSON对象形式返回GET请求参数</p> <p>req.query的值默认是个空对象</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 客户端浏览器发送的请求参数</span>
localhost<span class="token operator">:</span><span class="token number">3000</span><span class="token operator">/</span><span class="token keyword">get</span>

<span class="token comment">// 服务端响应回的内容</span>
<span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">// 客户端浏览器发送的请求参数</span>
localhost<span class="token operator">:</span><span class="token number">3000</span>/get?name=tom&amp;age=<span class="token number">18</span>

<span class="token comment">// 服务端响应回的内容</span>
<span class="token punctuation">{</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tom&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;age&quot;</span><span class="token operator">:</span> <span class="token string">&quot;18&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><hr> <h4 id="req-params"><a href="#req-params" class="header-anchor">#</a> req.params</h4> <p>可获取URL中通过 <strong>:</strong> 匹配到的<strong>动态参数</strong></p> <div class="language- extra-class"><pre class="language-text"><code>http://xxx/xxx/:自定义名
</code></pre></div><p>如下：</p> <ul><li>匹配一个动态参数：</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/user/:id'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>


app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'server running at localhost:80'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 客户端请求的URL地址和动态参数</span>
localhost<span class="token operator">:</span><span class="token number">3000</span><span class="token operator">/</span>user<span class="token operator">/</span><span class="token number">2000</span>

<span class="token comment">// 服务器响应回的内容</span>
<span class="token punctuation">{</span>
    <span class="token string">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2000&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>匹配多个动态参数：</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/user/:id/:name'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>


app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'server running at localhost:80'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 客户端请求的URL地址和动态参数</span>
localhost<span class="token operator">:</span><span class="token number">3000</span><span class="token operator">/</span>user<span class="token operator">/</span><span class="token number">2000</span><span class="token operator">/</span>name

<span class="token comment">// 服务器响应回的内容</span>
<span class="token punctuation">{</span>
    <span class="token string">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2000&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;andy&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><hr> <h4 id="req-body"><a href="#req-body" class="header-anchor">#</a> req.body</h4> <p>可获取存放在请求体中的 <strong>POST请求参数</strong></p> <p>若不配置解析请求体 req.body 的中间件解析的话，</p> <p>req.body默认返回一个 <strong>undefined</strong></p> <p>详见下文 - <a href="#%E8%A7%A3%E6%9E%90POST%E8%AF%B7%E6%B1%82%E5%8F%82%E6%95%B0%E6%A0%BC%E5%BC%8F%E7%9A%84%E5%86%85%E7%BD%AE%E4%B8%AD%E9%97%B4%E4%BB%B6">Express内置中间件</a></p> <ul><li><strong>JSON格式</strong>的POST请求参数</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 解析JSON格式POST请求参数的中间件</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/post'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>


app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'server running at localhost:80'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">// 解析结果</span>
<span class="token punctuation">{</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;andy&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;age&quot;</span><span class="token operator">:</span> <span class="token number">28</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><strong>x-www-form-urlencoded</strong>健值对格式的POST请求参数</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 解析x-www-form-urlencoded健值对格式POST请求参数的中间件</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">{</span> 
  extended<span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/post'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>


app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'server running at localhost:80'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//解析结果</span>
<span class="token punctuation">{</span>
    <span class="token string">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;andy&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;age&quot;</span><span class="token operator">:</span> <span class="token number">28</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="req-app-locals"><a href="#req-app-locals" class="header-anchor">#</a> req.app.locals</h4> <p>课通过在 req.app.locals 对象下挂载一个全局可用的属性</p> <div class="language-js extra-class"><pre class="language-js"><code>req<span class="token punctuation">.</span>app<span class="token punctuation">.</span>locals<span class="token punctuation">.</span>自定义属性 <span class="token operator">=</span> <span class="token string">'自定义内容'</span>
</code></pre></div><p>可用来做路由标记，让前端可以区分相关联的页面：</p> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/articles'</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 添加标识，当前是aritcles页面</span>
    req<span class="token punctuation">.</span>app<span class="token punctuation">.</span>locals<span class="token punctuation">.</span>nowPage <span class="token operator">=</span> <span class="token string">'articles'</span>
    
    res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'articles.art'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>比如，在art-template中根据页面路由的不同增加或去除class类名：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>col-sm-3 text-center text-white bg-dark pt-5 px-0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>nav</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>nav flex-column<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span>
      <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/admin/users<span class="token punctuation">&quot;</span></span>
      <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>{{ nowPage == <span class="token punctuation">'</span>users<span class="token punctuation">'</span> ? <span class="token punctuation">'</span>bg-primary<span class="token punctuation">'</span> : <span class="token punctuation">'</span><span class="token punctuation">'</span> }}<span class="token punctuation">&quot;</span></span>
      <span class="token punctuation">&gt;</span></span>Users List<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span>
    <span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span>
      <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/admin/articles<span class="token punctuation">&quot;</span></span>
      <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>{{ nowPage == <span class="token punctuation">'</span>articles<span class="token punctuation">'</span> ? <span class="token punctuation">'</span>bg-primary<span class="token punctuation">'</span> : <span class="token punctuation">'</span><span class="token punctuation">'</span> }}<span class="token punctuation">&quot;</span></span>
      <span class="token punctuation">&gt;</span></span>Articles List<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span>
    <span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>nav</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="res响应对象"><a href="#res响应对象" class="header-anchor">#</a> res响应对象</h3> <p>包含与响应相关的数据和属性</p> <hr> <h4 id="res-status"><a href="#res-status" class="header-anchor">#</a> res.status()</h4> <p>设置响应状态码</p> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/no'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'页面不存在'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><hr> <h4 id="res-send-方法"><a href="#res-send-方法" class="header-anchor">#</a> res.send()方法</h4> <p>通过res.send()将处理好的内容发送给客户端</p> <p>res.send()响应的参数可以是： **字符串文本 **或 <strong>JSON对象</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 响应GET请求</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        name<span class="token operator">:</span><span class="token string">'andy'</span><span class="token punctuation">,</span>
        age<span class="token operator">:</span><span class="token number">20</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 响应POST请求</span>
app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'POST请求发送成功'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>


app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Server Running at localhost:3000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>比底层Node.js的res.end( )更强大：</p> <ul><li>自动检测响应内容的数据类型和编码</li> <li>自动设置HTTP状态码</li></ul> <h2 id="托管静态资源"><a href="#托管静态资源" class="header-anchor">#</a> 托管静态资源</h2> <h3 id="express-static"><a href="#express-static" class="header-anchor">#</a> express.static()</h3> <p>可通过express.static() 快速创建一个 <strong>静态资源服务器</strong></p> <p>将静态资源文件图片、CSS文件、JS文件对外开放</p> <p>使用户可以通过URL访问被托管的静态资源目录下的资源</p> <p><strong>被托管的静态资源文件目录不会出现在访问的URL地址中</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span><span class="token string">'静态资源文件夹的绝对路径'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>如下：</p> <p>将项目中的 <strong>public文件夹 作为静态资源文件夹</strong>对外托管</p> <p>将该目录下的所有图片、CSS文件、JS文件等对外开放</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 项目目录</span>
项目
<span class="token operator">|</span><span class="token operator">-</span> <span class="token keyword">public</span>
		<span class="token operator">|</span><span class="token operator">-</span> images
				<span class="token operator">|</span><span class="token operator">-</span> <span class="token number">01.</span>jpg
		<span class="token operator">|</span><span class="token operator">-</span> css
				<span class="token operator">|</span><span class="token operator">-</span> style<span class="token punctuation">.</span>css
		<span class="token operator">|</span><span class="token operator">-</span> js
				<span class="token operator">|</span><span class="token operator">-</span> login<span class="token punctuation">.</span>js
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 静态资源服务器</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__diname<span class="token punctuation">,</span> <span class="token string">'public'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Server Running at localhost:3000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>用户访问时，URL地址的层级中并不包含被托管的public目录</p> <p>不然会路径错误找不到文件</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 用户可通过如下URL访问被托管的public目录下静态资源</span>

http://localhost:3000/images/o1.jpg
http://localhost:3000/css/style.css
http://localhost:3000/js/login.js
</code></pre></div><hr> <h3 id="托管多个静态资源目录"><a href="#托管多个静态资源目录" class="header-anchor">#</a> 托管多个静态资源目录</h3> <p>若要托管多个静态资源目录，</p> <p>就多次调用<strong>express.static()</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span><span class="token string">'public'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span><span class="token string">'files'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span><span class="token string">'static'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>访问静态文件时，会<strong>根据添加的顺序查找文件</strong></p> <p>会访问到添加托管的顺序在前面的同名资源</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">|</span><span class="token operator">-</span> files
		<span class="token operator">|</span><span class="token operator">-</span> index<span class="token punctuation">.</span>html
<span class="token operator">|</span><span class="token operator">-</span> <span class="token keyword">public</span>
		<span class="token operator">|</span><span class="token operator">-</span> index<span class="token punctuation">.</span>html
<span class="token operator">|</span><span class="token operator">-</span> <span class="token keyword">static</span>
		<span class="token operator">|</span><span class="token operator">-</span> index<span class="token punctuation">.</span>html
</code></pre></div><hr> <h3 id="静态资源路径添加前缀"><a href="#静态资源路径添加前缀" class="header-anchor">#</a> 静态资源路径添加前缀</h3> <p>若希望在静态资源的访问路径前挂载上路径前缀（路径层级）</p> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/前缀'</span><span class="token punctuation">,</span> express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span><span class="token string">'静态资源目录'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>用户是通过URL访问被托管的静态资源目录下的资源的</p> <p>原本被托管的静态资源文件目录<strong>不会出现在访问的URL地址中</strong></p> <p>若添加了静态资源的路径的前缀，</p> <p>则用户再想访问静态资源时必须在<strong>其URL地址前加上前缀</strong></p> <p>比如，添加的前缀是 <strong>'/public'</strong>：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 静态资源服务器</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/public'</span><span class="token punctuation">,</span> express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span><span class="token string">'public'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Server Running at localhost:3000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>则加上前缀后的URL访问地址改变如下：</p> <p>URL层级中多了 /public</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 添加路径前缀前</span>
http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">3000</span><span class="token operator">/</span>images<span class="token operator">/</span>o1<span class="token punctuation">.</span>jpg
http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">3000</span><span class="token operator">/</span>css<span class="token operator">/</span>style<span class="token punctuation">.</span>css
http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">3000</span><span class="token operator">/</span>js<span class="token operator">/</span>login<span class="token punctuation">.</span>js

<span class="token comment">// 添加路径前缀后</span>
http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">3000</span><span class="token operator">/</span><span class="token keyword">public</span><span class="token operator">/</span>images<span class="token operator">/</span>o1<span class="token punctuation">.</span>jpg
http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">3000</span><span class="token operator">/</span><span class="token keyword">public</span><span class="token operator">/</span>css<span class="token operator">/</span>style<span class="token punctuation">.</span>css
http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">3000</span><span class="token operator">/</span><span class="token keyword">public</span><span class="token operator">/</span>js<span class="token operator">/</span>login<span class="token punctuation">.</span>js
</code></pre></div><h2 id="express路由"><a href="#express路由" class="header-anchor">#</a> Express路由</h2> <h3 id="概念"><a href="#概念" class="header-anchor">#</a> 概念</h3> <p>Express中的路由是指</p> <p><strong>客户端的请求URL</strong> 和 <strong>服务器的处理函数</strong> 之间的映射关系</p> <h3 id="路由匹配过程"><a href="#路由匹配过程" class="header-anchor">#</a> 路由匹配过程</h3> <p>一个请求到达服务器后，</p> <p>会按照服务端路由<strong>定义的先后顺序</strong> 将请求与路由进行匹配，</p> <p>匹配成功后就不会在去匹配定义顺序在后面的路由了</p> <p>只有<strong>请求类型和请求URL同时匹配成功</strong>了，</p> <p>Express才会调用相对应的处理函数</p> <h3 id="基础路由"><a href="#基础路由" class="header-anchor">#</a> 基础路由</h3> <p>Express中路由分为3部分：</p> <ul><li><p>请求类型</p></li> <li><p>请求的URL地址</p></li> <li><p>处理函数</p></li></ul> <p>在Express中，最简单的实现路由方式，</p> <p>是将路由挂载到app上：</p> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">请求方式</span><span class="token punctuation">(</span><span class="token string">'请求URL地址'</span><span class="token punctuation">,</span> 处理函数<span class="token punctuation">)</span>
</code></pre></div><p>如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/home'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'访问了首页'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/about'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'访问了about页面'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/home'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'访问了首页'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>


app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Server Running at localhost:3000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>但是因为日后代码量会增多，</p> <p>很少会直接将路由挂在到app上，而是采取模块化路由，</p> <p>在单独的文件中管理路由API，入口文件只负责调用路由模块</p> <h3 id="模块化路由"><a href="#模块化路由" class="header-anchor">#</a> 模块化路由</h3> <p>为了方便对路由的模块化管理，</p> <p>不建议直接将路由挂在到app，</p> <p>而是应该 <strong>将路由都抽离为单独的模块（单独的JS文件）</strong></p> <hr> <h4 id="创建与导入步骤"><a href="#创建与导入步骤" class="header-anchor">#</a> 创建与导入步骤</h4> <p><strong>1. 单独文件中创建路由模块</strong></p> <p>将路由都写在一个单独的JS文件中，方便管理维护</p> <ol><li><p>调用express.Router() 创建路由对象</p></li> <li><p>将挂载到路由对象router上</p></li> <li><p>使用moudule.exports对外暴露路由</p></li></ol> <p>如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 1. 导入express</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token comment">// 2.创建路由对象</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 3. 挂载路由到路由对象上</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/user/list'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'获得用户列表'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 3. 挂载路由到路由对象上</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/user/add'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'添加用户'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 4. 对外暴露出路由对象</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router
</code></pre></div><p><strong>2. 入口文件中导入注册路由模块</strong></p> <p>创建的单独的路由模块文件需要被导入服务器入口文件</p> <ol><li>require() 导入路由模块</li> <li>app.use() 注册路由模块</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 1. 导入路由模块（JS文件）</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./Router.js'</span><span class="token punctuation">)</span>
<span class="token comment">// 2. 注册路由模块</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">)</span>


app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Server Running at localhost:3000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><hr> <h4 id="多个路由模块"><a href="#多个路由模块" class="header-anchor">#</a> 多个路由模块</h4> <p>如下，分别创建了两个路由模块，然后分别在入口文件中导入挂载调用</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 路由模块user</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> user <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

user<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/user/list'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'获得用户列表'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
user<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/user/add'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'添加用户'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> user
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 路由模块products</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> product <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

product<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/product/list'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'获得商品列表'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
product<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/product/add'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'添加商品'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> product
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// main.js</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 导入路由模块user</span>
<span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./routes/user.js'</span><span class="token punctuation">)</span>
<span class="token comment">// 导入路由模块products</span>
<span class="token keyword">const</span> product <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./routes/products.js'</span><span class="token punctuation">)</span>

<span class="token comment">// 	调用路由</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>product<span class="token punctuation">)</span>
</code></pre></div><h3 id="路由模块添加前缀"><a href="#路由模块添加前缀" class="header-anchor">#</a> 路由模块添加前缀</h3> <p>类似于托管静态资源访问路径挂载前缀</p> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/public'</span><span class="token punctuation">,</span> express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span><span class="token string">'public'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>若添加了路由前缀，</p> <p>则用户再想访问URL地址时必须在<strong>其URL地址前加上前缀</strong></p> <p>如下，给路由URL地址加上 <strong>/api</strong> 前缀：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 服务器入口文件</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./Router.js'</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/api'</span><span class="token punctuation">,</span> router<span class="token punctuation">)</span>


app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Server Running at localhost:3000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 路由模块</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/user/list'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'获得用户列表'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/user/add'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'添加用户'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router
</code></pre></div><p>则加上前缀后的URL访问地址改变如下：</p> <p>URL层级中多了 /api</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 添加路径前缀前</span>
http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">3000</span><span class="token operator">/</span>user<span class="token operator">/</span>list
http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">3000</span><span class="token operator">/</span>user<span class="token operator">/</span>add

<span class="token comment">// 添加路径前缀后</span>
http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">3000</span><span class="token operator">/</span>api<span class="token operator">/</span>user<span class="token operator">/</span>list
http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">3000</span><span class="token operator">/</span>api<span class="token operator">/</span>user<span class="token operator">/</span>add
</code></pre></div><h3 id="路由参数"><a href="#路由参数" class="header-anchor">#</a> 路由参数</h3> <p>出来在请求URL结尾通过查询字符串传递参数，</p> <p>还可以通过路由参数传递</p> <hr> <h4 id="传递与接收"><a href="#传递与接收" class="header-anchor">#</a> 传递与接收</h4> <ul><li><strong>服务端设置路由地址和接收参数</strong></li></ul> <p>在路由请求地址后通过  <strong>: 参数</strong> 设置路由参数</p> <p>相当一个占位符</p> <p>接收路由参数时通过req.parmas接收</p> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/search/:id'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'OK'</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>parmas<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><ul><li><strong>客户端传递参数</strong></li></ul> <p>不再用 ？在URL分割，而是直接接在URL后</p> <p>访问请求地址时必须写上完整的地址+ 参数</p> <div class="language-js extra-class"><pre class="language-js"><code>localhost<span class="token operator">:</span><span class="token number">3000</span><span class="token operator">/</span>find<span class="token operator">/</span><span class="token number">123</span>
localhost<span class="token operator">:</span><span class="token number">3000</span><span class="token operator">/</span>find<span class="token operator">/</span>food
</code></pre></div><hr> <h4 id="多个路由参数"><a href="#多个路由参数" class="header-anchor">#</a> 多个路由参数</h4> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/search/:category/:type/:id'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'OK'</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>parmas<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code>localhost<span class="token operator">:</span><span class="token number">3000</span><span class="token operator">/</span>find<span class="token operator">/</span><span class="token number">123</span>
localhost<span class="token operator">:</span><span class="token number">3000</span><span class="token operator">/</span>find<span class="token operator">/</span>food
</code></pre></div><h3 id="路由重定向"><a href="#路由重定向" class="header-anchor">#</a> 路由重定向</h3> <div class="language-js extra-class"><pre class="language-js"><code>res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'完整路由地址'</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code>admin<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// get client form vale</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> email<span class="token punctuation">,</span> password <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body

    <span class="token comment">// server side form value validation</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>email<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> password<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'admin/error'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
            status<span class="token operator">:</span> <span class="token number">400</span><span class="token punctuation">,</span>
            msg<span class="token operator">:</span> <span class="token string">'Email Address or Password is WRONG,  will back to login page in 2s'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// according to email to check unique user info</span>
    <span class="token keyword">let</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> email <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// if there is that unique one, user is  an obj,or a {}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// bcrypt compare password</span>
        <span class="token keyword">const</span> isEqual <span class="token operator">=</span> <span class="token keyword">await</span> bcrypt<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> user<span class="token punctuation">.</span>password<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isEqual<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 储存登陆用户的信息到session中</span>
            req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>username <span class="token operator">=</span> user<span class="token punctuation">.</span>username
						<span class="token comment">// 重定向</span>
            res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/admin/users'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// art-template 公用变量（用户名显示在右上角）</span>
            req<span class="token punctuation">.</span>app<span class="token punctuation">.</span>locals<span class="token punctuation">.</span>userInfo <span class="token operator">=</span> user<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// wrong password</span>
            res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'admin/error'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
                status<span class="token operator">:</span> <span class="token number">400</span><span class="token punctuation">,</span>
                msg<span class="token operator">:</span> <span class="token string">'Email Address or Password is WRONG,  will back to login page in 2s'</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// no such email</span>
        res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'admin/error'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
            status<span class="token operator">:</span> <span class="token number">400</span><span class="token punctuation">,</span>
            msg<span class="token operator">:</span> <span class="token string">'Cannot find such user,  will back to login page in 2s'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="路由拦截-登陆拦截"><a href="#路由拦截-登陆拦截" class="header-anchor">#</a> 路由拦截/登陆拦截</h3> <p>路由拦截，是指在访问路由地址前先进行某种判断，符合后才能访问</p> <p>是个通过app.use( ) 使用的中间件，必须写在所有路由的前面</p> <p>条件符合的话才能执行访问其余路由，通过next() 开放请求的向下传递</p> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'路由'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
     <span class="token comment">// 重定向</span>
     res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'路由'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>如下：登陆验证的路由拦截：</p> <ul><li>判断地址是否是 /admin/login 页面进行的跳转</li> <li>且服务器的session对象中是否存有用户信息（即用户是否登陆过）</li></ul> <p>若直接从地址栏请求访问 /admin/xxxxxx 路由地址时，且用户未login登陆过服务器，则直接重定向会login页面</p> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/admin'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>url <span class="token operator">!=</span> <span class="token string">'/login'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>username<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 重定向到 /admin/login</span>
        res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/admin/login'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 继续执行其余路由</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

Routes<span class="token operator">...</span><span class="token punctuation">.</span>
</code></pre></div><h2 id="express中间件"><a href="#express中间件" class="header-anchor">#</a> Express中间件</h2> <h3 id="基础概念"><a href="#基础概念" class="header-anchor">#</a> 基础概念</h3> <p>中间件（Middleware）,中间处理的环节</p> <p>中间件必须有输入输出，</p> <p>可以存在多个中间件连续调用，</p> <p>上一级中间件的输出作为下一级中间件的输入</p> <hr> <h4 id="express中间件调用流程"><a href="#express中间件调用流程" class="header-anchor">#</a> Express中间件调用流程</h4> <p>当一个客户端请求到达Express的服务器后，</p> <ol><li><p>可以<strong>连续调用多个中间件</strong>，对这次请求进行<strong>预处理</strong></p></li> <li><p>客户端发来的请求会按照中间件定义先后顺序进行调用，</p> <p>上一级中间件的输出作为下一级中间件的输入</p></li> <li><p><strong>所有中间件的都调用完毕</strong>后再将处理完毕的结果交给路由处理</p></li></ol> <img src="https://pbs.twimg.com/media/E3ZmKD4VoAA0Tw8?format=png&amp;name=900x900" style="zoom:50%;"> <p>详见下文 - <a href="##%E5%AE%9A%E4%B9%89%E5%A4%9A%E4%B8%AA%E5%85%A8%E5%B1%80%E4%B8%AD%E9%97%B4%E4%BB%B6">定义多个全局中间件</a></p> <hr> <h4 id="express中间件本质与一般路由函数"><a href="#express中间件本质与一般路由函数" class="header-anchor">#</a> Express中间件本质与一般路由函数</h4> <p>本质是个<strong>function函数</strong></p> <p>但是一般的路由处理函数只有req、res两个对象参数，</p> <p>中间件函数的形参列表中还必须有一个 <strong>next函数做参数</strong>，</p> <p>并且当前中间件处理完毕后必须调用<strong>next()</strong>，</p> <p><img src="https://pbs.twimg.com/media/E3ZnO9nUUAAW5Ft?format=jpg&amp;name=medium" alt=""></p> <p>因此，可根据函数的参数区分 <strong>一般路由函数</strong> 与 <strong>中间件函数</strong>：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 一般路由函数</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  xxxxxxx
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 中间件函数</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  xxxxxxxx
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><hr> <h4 id="共享-req-和-res参数"><a href="#共享-req-和-res参数" class="header-anchor">#</a> 共享 req 和 res参数</h4> <p><strong>多个中间件函数和路由函数之间共享 req对象 和 res对象</strong></p> <p>基于中间件的执行流程是上一个处理完后结果给下一个，</p> <p>且多个中间件和路由共享req和res参数，</p> <p>因此，</p> <p>可在上游中间件中<strong>为 req和res 挂载自定义属性或方法</strong>，</p> <p><strong>下游中间件或路由中使用</strong> 上游中间件中挂载的自定义属性或方法</p> <p>详见下文 - <a href="##%E5%85%A8%E5%B1%80%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%9A%84%E4%BD%9C%E7%94%A8">全局中间件</a></p> <hr> <h4 id="next函数作用"><a href="#next函数作用" class="header-anchor">#</a> next函数作用</h4> <p>中间件函数的形参列表中还必须有一个 <strong>next函数做参数</strong>，</p> <p>next函数是<strong>实现多个中间件连续调用</strong>的关键</p> <p>当前中间件处理完毕后必须调用<strong>next()</strong>，表示流转关系的转交</p> <p>即，将处理结果交给下一个中间件处理 或 最终交给路由处理</p> <img src="https://pbs.twimg.com/media/E3ZmKD4VoAA0Tw8?format=png&amp;name=900x900" style="zoom:50%;"> <h3 id="中间件注意点"><a href="#中间件注意点" class="header-anchor">#</a> 中间件注意点</h3> <ul><li><p><strong>必须在定义路由函数前定义中间件</strong>（错误级别中间件例外）</p> <p>因为请求到服务器后是从上到下匹配</p></li> <li><p>客户端发送来的请求<strong>可以连续调用多个中间件进行处理</strong></p></li> <li><p>连续调用多个中间件时，多个中间件和路由<strong>共享req、res对象参数</strong></p></li> <li><p>中间件函数处理完后必须调用<strong>next()</strong> ，表示处理结束并传递处理结果</p> <p>不然请求在该中间件处就终止了，<strong>无法继续匹配下去</strong></p></li></ul> <h3 id="全局生效中间件"><a href="#全局生效中间件" class="header-anchor">#</a> 全局生效中间件</h3> <p><strong>客户端发起的任何请求到达服务器后都会被触发的中间件</strong>，叫做全局生效中间件</p> <hr> <h4 id="app-use"><a href="#app-use" class="header-anchor">#</a> app.use()</h4> <p>可通过 app.use() 将一个中间件注册为全局生效中间件</p> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>中间件名<span class="token punctuation">)</span>
</code></pre></div><p>如下：</p> <p>定义并注册一个全局生效中间件</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 1. 定义一个中间件</span>
<span class="token keyword">const</span> <span class="token function-variable function">middleWare</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'基础中间件'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 流转关系转交下一个中间件路由</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 2. 注册为全局生效中间件</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>middleWare<span class="token punctuation">)</span>
</code></pre></div><p>简写：</p> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'基础中间件'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 流转关系转交下一个中间件路由</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><hr> <h4 id="定义多个全局中间件"><a href="#定义多个全局中间件" class="header-anchor">#</a> 定义多个全局中间件</h4> <p>可<strong>使用app.use()连续定义</strong>多个全局中间件</p> <p>客户端发来的请求会按照中间件定义先后顺序进行调用中间件</p> <p>如下：</p> <p>只要有请求发来服务器，就会按照顺序打印NO1,NO2,</p> <p>若是GET请求访问了根目录，就会按照顺序打印NO1,NO2,NO3</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>


app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'NO1, 中间件第 1 次调用'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'NO2, 中间件第 2 次调用'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'NO3, GET请求访问路由地址'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'GET请求访问了首页'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'NO3, POST请求访问路由地址'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'POST请求访问了首页'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'server running at localhost:80'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><hr> <h4 id="作用1-处理重复内容"><a href="#作用1-处理重复内容" class="header-anchor">#</a> 作用1 处理重复内容</h4> <p>若每一个路由函数中，</p> <p>都有必须执行的处理逻辑，或有着相同重复的处理逻辑，</p> <p>可以该部分写入一个全局中间件</p> <p>如下：</p> <p>获取用户访问路由地址的时间</p> <ul><li>若不通过中间件，需要在每个路由函数中都重复相同代码：</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> time <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> time <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'server running at localhost:80'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>使用了中间件：</li></ul> <p>因为<strong>中间件的调用流程</strong>，<strong>中间件之间和路由共享req，res</strong>的机制</p> <p>给上游中间件的<strong>req/res挂载自定义属性或方法</strong>，供下游中间件火路由使用</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> time <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token comment">// 给req挂载自定义属性，使下一个中间件或路由可以使用</span>
    req<span class="token punctuation">.</span>startTime <span class="token operator">=</span> time
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token comment">// 使用上游中间件中挂载到req上的自定义属性</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>startTime<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token comment">// 使用上游中间件中挂载到req上的自定义属性</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>startTime<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>


app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'server running at localhost:80'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><hr> <h4 id="作用2-登陆验证"><a href="#作用2-登陆验证" class="header-anchor">#</a> 作用2 登陆验证</h4> <p>app.use( )可在参数中设置URL请求地址，接收处理所有请求</p> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/请求地址'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  xxxx
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>可用于，必须要确认登陆后才能访问的地址请求的场合，</p> <p>可通过中间件拦截所有请求，进行<strong>登陆状态验证</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> isLogin <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>isLogin<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'还未登陆'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'欢迎登陆'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><hr> <h4 id="作用3-网站维护公告"><a href="#作用3-网站维护公告" class="header-anchor">#</a> 作用3 网站维护公告</h4> <p>比如网站维护时，不希望用户访问</p> <p>可通过中间件拦截终止所有请求，不调用next( )</p> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'网站维护中，无法访问'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/...'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  xxx
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/...'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  xxx
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><hr> <h4 id="作用4-定义404页面"><a href="#作用4-定义404页面" class="header-anchor">#</a> 作用4 定义404页面</h4> <p>中间件时从上到下逐一匹配，</p> <p>若请求地址和所有的路由都没匹配成功，即该请求不存在</p> <p>所以，404页面响应处理的中间件必须定义在所有路由之后</p> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/...'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  xxx
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/...'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  xxx
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator">...</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span>
  	 <span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'当前访问页面不存在'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="局部生效中间件"><a href="#局部生效中间件" class="header-anchor">#</a> 局部生效中间件</h3> <p>局部生效中间件是指，</p> <p><strong>不用 app.use() 定义的中间件</strong></p> <h4 id="定义局部中间件"><a href="#定义局部中间件" class="header-anchor">#</a> 定义局部中间件</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">局部中间件</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  xxxxx
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><hr> <h4 id="路由使用局部中间件"><a href="#路由使用局部中间件" class="header-anchor">#</a> 路由使用局部中间件</h4> <p>路由函数若想接收某个局部中间件的处理结果，</p> <p>只需要在路由函数的<strong>第2个参数位置</strong>导入该局部中间件即可</p> <p>局部中间件的结果仅在调用了该中间件的路由中被访问使用，</p> <p>没有导入该中间件的路由函数中无法访问实用局部中间件</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 接受局部中间件处理结果的路由</span>
app<span class="token punctuation">.</span><span class="token function">请求方式</span><span class="token punctuation">(</span><span class="token string">'/路由地址'</span><span class="token punctuation">,</span> 局部中间件<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  xxxxxxxx
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 没接受局部中间件处理结果的路由</span>
app<span class="token punctuation">.</span><span class="token function">请求方式</span><span class="token punctuation">(</span><span class="token string">'/路由地址'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  xxxxxxxx
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">mv</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'调用了局部中间件'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> mv<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'GET请求访问路由地址'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'GET请求访问了首页'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'POST请求访问路由地址'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'POST请求访问了首页'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>


app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'server running at localhost:80'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><hr> <h4 id="定义多个局部中间件"><a href="#定义多个局部中间件" class="header-anchor">#</a> 定义多个局部中间件</h4> <p>按顺序function定义即可</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">mv1</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'调用了局部中间件 - 1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token function-variable function">mv2</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'调用了局部中间件 - 2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><hr> <h4 id="路由使用多个局部中间件"><a href="#路由使用多个局部中间件" class="header-anchor">#</a> 路由使用多个局部中间件</h4> <p>在路由中有<strong>两种等价的方式</strong>使用多个局部中间件</p> <ul><li><p>方法一：</p> <p>多个局部中间件逗号隔开</p></li></ul> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">请求方式</span><span class="token punctuation">(</span><span class="token string">'/路由地址'</span><span class="token punctuation">,</span> 局部中间件<span class="token number">1</span><span class="token punctuation">,</span> 局部中间件<span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  xxxxxxxx
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><ul><li><p>方法二：</p> <p>多个局部中间件放入数组</p></li></ul> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">请求方式</span><span class="token punctuation">(</span><span class="token string">'/路由地址'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>局部中间件<span class="token number">1</span><span class="token punctuation">,</span> 局部中间件<span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  xxxxxxxx
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">mv1</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'调用了局部中间件 - 1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token function-variable function">mv2</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'调用了局部中间件 - 2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 采用方法一的路由</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> mv1<span class="token punctuation">,</span> mv2<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">re1<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'获得了GET请求'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'获得了GET请求'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 采用方法二的路由</span>
app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>mv1<span class="token punctuation">,</span> mv2<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">re1<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'获得了POST请求'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'获得了POST请求'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre></div><h3 id="中间件分类"><a href="#中间件分类" class="header-anchor">#</a> 中间件分类</h3> <p>Express将中间件分为五大类：</p> <ul><li><strong>应用级别</strong>中间件</li> <li><strong>路由级别</strong>中间件</li> <li><strong>错误级别</strong>中间件</li> <li><strong>Express内置</strong>中间件</li> <li><strong>第三方</strong>中间件</li></ul> <hr> <h4 id="应用级别中间件"><a href="#应用级别中间件" class="header-anchor">#</a> 应用级别中间件</h4> <p>应用级别中间件是指，</p> <p>绑定到Express实例app上的中间件，通过：</p> <ul><li><strong>app.use()</strong></li> <li><strong>app.get()</strong></li> <li><strong>app.post()</strong></li></ul> <p>**app.use() **绑定的是全局中间件</p> <p><strong>app.get() <strong>与</strong>app.post()</strong> 绑定的是局部中间件</p> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  xxxxx
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'路由地址'</span><span class="token punctuation">,</span> 局部中间件名<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  xxxxx
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><hr> <h4 id="路由级别中间件"><a href="#路由级别中间件" class="header-anchor">#</a> 路由级别中间件</h4> <p>路由级别中间件是指，</p> <p>绑定到 express.Router() 路由实例上的中间件</p> <p>和应用级别中间件没有区别，只是挂载的对象不同，</p> <p>应用级别中间件是绑定到了app实例上</p> <p>路由级别中间件是绑定到了router实例上</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  xxxxx
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><hr> <h4 id="错误级别中间件"><a href="#错误级别中间件" class="header-anchor">#</a> 错误级别中间件</h4> <p>程序一旦出错就无法运行了（比如读取不到文件）</p> <p>可通过错误处理中间件，</p> <p><strong>捕获整个项目中发生的异常错误，统一处理，防止项目异常崩溃</strong></p> <p>若没有该中间件，会导致出现错误服后务器会崩溃掉</p> <blockquote><p>一般路由函数有2个参数（调用局部中间件时会增多）</p> <p>普通中间件函数有3个参数</p></blockquote> <ul><li><p>错误级别中间件函数<strong>有4个参数</strong></p> <p>参数顺序分别是 <strong>err、req、res、next</strong></p></li></ul> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  xxxxx
  res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span>
  	 <span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'发现了错误'</span> <span class="token operator">+</span> err<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
  
   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'发现了错误'</span> <span class="token operator">+</span> err<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><ul><li><p>错误级别中间件<strong>必须注册在所有路由之后</strong>，否则不会生效</p> <p>（其余中间件都是注册在路由之前）</p></li></ul> <p>如下：</p> <p>通过 throw new Error() 模拟一个错误</p> <p>请求发送到服务器后会产生错误会被错误级别中间件捕获，</p> <p>阻止了因为错误导致服务器的崩溃</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 模拟错误</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/error'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'服务器出现错误'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 定义错误级别中间件</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'发现了错误'</span> <span class="token operator">+</span> err<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'发现了错误'</span> <span class="token operator">+</span> err<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>


app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'server running at localhost:80'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>再比如：</p> <p>异步的错误不能直接被错误处理中间件获取，</p> <p>需要通过给next（）传递参数，直接触发错误处理中间件</p> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/index'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'./index.txt'</span><span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token function">next</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  xxxxx
  res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span>
  	 <span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'发现了错误'</span> <span class="token operator">+</span> err<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><hr> <h4 id="express内置中间件"><a href="#express内置中间件" class="header-anchor">#</a> Express内置中间件</h4> <p>Express4.16.0版本后，内置了3个常用中间件：</p> <p>都是全局生效中间件，需要通过 <strong>app.use()</strong> 使用</p> <ul><li><p><strong>express.static()</strong></p> <p>用于快速托管项目的静态资源</p></li> <li><p><strong>express.json()</strong></p> <p><strong>解析JSON格式的请求体数据</strong></p> <p>有兼容性，仅4.16.0+版本可用</p></li> <li><p><strong>express.urlencoded()</strong></p> <p><strong>解析URL-endoded格式的请求体数据</strong></p> <p>有兼容性，仅4.16.0+版本可用</p></li></ul> <hr> <h4 id="第三方中间件"><a href="#第三方中间件" class="header-anchor">#</a> 第三方中间件</h4> <p>按需下载使用</p> <ul><li><p><strong>cors</strong></p> <p>解决跨域问题</p></li> <li><p><strong>body-parser</strong></p> <p><strong>解析JSON格式的请求体数据</strong></p> <p>Express4.16.0版本之前使用</p></li></ul> <p>body-parser使用：</p> <p>安装：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> i body-parser
</code></pre></div><p>解析<strong>x-www-form-urlencoded</strong>健值对格式的POST请求参数</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> bodyparser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'body-parser'</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>bodyparser<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    extended<span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/post'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>


app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'server running at localhost:80'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="解析请求体数据格式的中间件"><a href="#解析请求体数据格式的中间件" class="header-anchor">#</a> 解析请求体数据格式的中间件</h3> <p>对于POST请求参数，若不配置解析请求体 req.body 的中间件的话，</p> <p>默认req.body 返回 <strong>undefined</strong></p> <hr> <h4 id="express-json"><a href="#express-json" class="header-anchor">#</a> express.json()</h4> <p>解析<strong>JSON</strong>格式的POST请求参数</p> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>


app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/post/json'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>


app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'server running at localhost:80'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><hr> <h4 id="express-urlencoded"><a href="#express-urlencoded" class="header-anchor">#</a> express.urlencoded()</h4> <p>解析<strong>x-www-form-urlencoded</strong>健值对格式的POST请求参数</p> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">{</span> 
  extended<span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>


app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/post/json'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>


app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'server running at localhost:80'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><hr> <h4 id="body-parser"><a href="#body-parser" class="header-anchor">#</a> body-parser</h4> <p>Express4.16.0版本之前使用</p> <p>内置中间件express.urlencoded()就是基于body-parser封装的</p> <h3 id="自定义中间件"><a href="#自定义中间件" class="header-anchor">#</a> 自定义中间件</h3> <p>模拟一下 body-parser的功能</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> qs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'querystring'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 解析 x-www-form-urlencoded健值对格式的POST请求参数</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> str <span class="token operator">=</span> <span class="token string">''</span>
    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        str <span class="token operator">+=</span> chunk
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// console.log(qs.parse(str));</span>
        req<span class="token punctuation">.</span>body <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>  
<span class="token punctuation">}</span><span class="token punctuation">)</span>


app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/data'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> 
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'server running at localhost:80'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>封装并导出自定义的中间件：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> qs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'querystring'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">bodyParser</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> str <span class="token operator">=</span> <span class="token string">''</span>
    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        str <span class="token operator">+=</span> chunk
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        req<span class="token punctuation">.</span>body <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span>
</code></pre></div><p>导入使用自定义中间件：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> bd <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'自定义中间件文件位置'</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>bd<span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="捕获错误"><a href="#捕获错误" class="header-anchor">#</a> 捕获错误</h3> <p>同步的错误可以被错误级别中间件捕获</p> <p>异步可以通过给next( )传递错误内容杂技节交给错误级别中间件处理</p> <p>异步还可通过Promise对象的API catch()获取</p> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>_id<span class="token operator">:</span> <span class="token string">'xxx0xxx'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">next</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="请求参数"><a href="#请求参数" class="header-anchor">#</a> 请求参数</h2> <h3 id="传递"><a href="#传递" class="header-anchor">#</a> 传递</h3> <h4 id="get请求参数"><a href="#get请求参数" class="header-anchor">#</a> GET请求参数</h4> <ul><li>查询字符串</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>localhost<span class="token operator">:</span><span class="token number">3000</span><span class="token operator">/</span>find<span class="token operator">?</span>name<span class="token operator">=</span>andy<span class="token operator">&amp;</span>id<span class="token operator">=</span><span class="token number">28</span>
</code></pre></div><ul><li>路由参数</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>localhost<span class="token operator">:</span><span class="token number">3000</span><span class="token operator">/</span>find<span class="token operator">/</span>andy<span class="token operator">/</span><span class="token number">28</span>
</code></pre></div><h4 id="post请求参数"><a href="#post请求参数" class="header-anchor">#</a> POST请求参数</h4> <ul><li>请求体</li></ul> <hr> <h3 id="接收"><a href="#接收" class="header-anchor">#</a> 接收</h3> <h4 id="get请求参数-2"><a href="#get请求参数-2" class="header-anchor">#</a> GET请求参数</h4> <ul><li>查询字符串</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/index'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>query<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>路由参数</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/index/:name/:id'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>parmas<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="post请求参数-2"><a href="#post请求参数-2" class="header-anchor">#</a> POST请求参数</h4> <ul><li>body-parser使用：</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> i body-parser
</code></pre></div><p>解析<strong>x-www-form-urlencoded</strong>健值对格式的POST请求参数</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> bodyparser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'body-parser'</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>bodyparser<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    extended<span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/index'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><ul><li><strong>express.json()</strong></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//JSON格式的POST请求参数</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/post'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><ul><li><strong>express.urlencoded()</strong></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// **x-www-form-urlencoded**健值对格式的POST请求参数</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">{</span> 
  extended<span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">{</span> 
  extended<span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/post'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="express写接口"><a href="#express写接口" class="header-anchor">#</a> Express写接口</h2> <ol><li><p>创建路由模块</p></li> <li><p>导入路由模块</p></li> <li><p>在导入路由模块前，配置解析表单数据的中间件</p> <p>app.use(express.json())</p> <p>或 app.use(express.urlencoded({extended:false}))</p></li></ol> <ul><li><strong>路由模块</strong></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// GET</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/get'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> query <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token comment">// 0: succeed  1:failed</span>
        status<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        msg<span class="token operator">:</span> <span class="token string">'GET Request Succeed!!!'</span><span class="token punctuation">,</span>
        data<span class="token operator">:</span> query
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// POST</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/post'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> body <span class="token operator">=</span> req<span class="token punctuation">.</span>body
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token comment">// 0: succeed  1:failed</span>
        status<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        msg<span class="token operator">:</span> <span class="token string">'POST Request Succeed!!!'</span><span class="token punctuation">,</span>
        data<span class="token operator">:</span> body
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router
</code></pre></div><ul><li><strong>入口文件</strong></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// urlencoded</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    extended<span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token comment">// router</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./router'</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/api'</span><span class="token punctuation">,</span> router<span class="token punctuation">)</span>



<span class="token keyword">const</span> port <span class="token operator">=</span> <span class="token number">3000</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Server running at loaclhost:3000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>上文的API接口存在一个问题，不支持跨域请求</p> <h2 id="通过express写接口"><a href="#通过express写接口" class="header-anchor">#</a> 通过Express写接口</h2> <h3 id="cors-跨域资源共享"><a href="#cors-跨域资源共享" class="header-anchor">#</a> CORS（跨域资源共享）</h3> <p>详见笔记 <a href="https://github.com/BlaxBerry/StudyNotes/blob/master/%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1/%E5%90%8C%E6%BA%90%EF%BD%9C%E8%B7%A8%E5%9F%9F%EF%BD%9CJSONP.md" target="_blank" rel="noopener noreferrer">同源｜跨域｜JSONP｜CORS <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <hr> <h4 id="第三方中间件cors"><a href="#第三方中间件cors" class="header-anchor">#</a> 第三方中间件cors</h4> <p>可以通过一个是Express的第三方中间件，<strong>cors</strong> 来用于解决跨域问题</p> <ol><li>npm安装</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> i cors
</code></pre></div><ol start="2"><li><strong>必须在所有路由之前使用cros中间件</strong></li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> cors <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cors'</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><hr> <h4 id="通过cors中间件配置cors"><a href="#通过cors中间件配置cors" class="header-anchor">#</a> 通过cors中间件配置CORS</h4> <ul><li>入口文件</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// urlencoded</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    extended<span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token comment">// CORS </span>
<span class="token keyword">const</span> cors <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cors'</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// router</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./router'</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/api'</span><span class="token punctuation">,</span> router<span class="token punctuation">)</span>



<span class="token keyword">const</span> port <span class="token operator">=</span> <span class="token number">3000</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Server running at loaclhost:3000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>路由模块</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// GET 接口</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/get'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> query <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token comment">// 0: succeed  1:failed</span>
        status<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        msg<span class="token operator">:</span> <span class="token string">'GET Request Succeed!!!'</span><span class="token punctuation">,</span>
        data<span class="token operator">:</span> query
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// POST 接口</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/post'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> body <span class="token operator">=</span> req<span class="token punctuation">.</span>body
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token comment">// 0: succeed  1:failed</span>
        status<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        msg<span class="token operator">:</span> <span class="token string">'POST Request Succeed!!!'</span><span class="token punctuation">,</span>
        data<span class="token operator">:</span> body
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router
</code></pre></div><ul><li>Ajax请求</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>


        <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#get'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
                name<span class="token operator">:</span> <span class="token string">'Andy'</span><span class="token punctuation">,</span>
                age<span class="token operator">:</span> <span class="token number">28</span>
            <span class="token punctuation">}</span>
            
            <span class="token function">sendAjax</span><span class="token punctuation">(</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'http://127.0.0.1:3000/api/get'</span><span class="token punctuation">,</span>data<span class="token punctuation">)</span>
            
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#post'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
                name<span class="token operator">:</span> <span class="token string">'Tom'</span><span class="token punctuation">,</span>
                age<span class="token operator">:</span> <span class="token number">20</span>
            <span class="token punctuation">}</span>
            <span class="token function">sendAjax</span><span class="token punctuation">(</span><span class="token string">'POST'</span><span class="token punctuation">,</span> <span class="token string">'http://127.0.0.1:3000/api/post'</span><span class="token punctuation">,</span>data<span class="token punctuation">)</span>
           
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

      
        <span class="token keyword">function</span> <span class="token function">sendAjax</span><span class="token punctuation">(</span><span class="token parameter">method<span class="token punctuation">,</span> url<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                type<span class="token operator">:</span> method<span class="token punctuation">,</span>
                url<span class="token operator">:</span> url<span class="token punctuation">,</span>
                data<span class="token operator">:</span> data<span class="token punctuation">,</span>
                <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>


    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="jsonp接口"><a href="#jsonp接口" class="header-anchor">#</a> JSONP接口</h3> <p>详见笔记 <a href="https://github.com/BlaxBerry/StudyNotes/blob/master/%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1/%E5%90%8C%E6%BA%90%EF%BD%9C%E8%B7%A8%E5%9F%9F%EF%BD%9CJSONP.md" target="_blank" rel="noopener noreferrer">同源｜跨域｜JSONP｜CORS <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <hr> <p>若已经配置了CORS跨域资源共享，</p> <p>为了防止冲突导致JSONP接口被处理为开启了CORS的接口</p> <p><strong>必须将JSONP接口配置在 声明CORS中间件之前</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// JSONP 接口</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'api/jsonp'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  xxxx
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 开启CORS</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// 开启了CORS的接口</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'api/get'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  xxxxxx
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="实现"><a href="#实现" class="header-anchor">#</a> 实现</h4> <ul><li>服务端：</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// JSONP请求的处理</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/jsonp'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> fun <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>callback
    <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
        name<span class="token operator">:</span> <span class="token string">'JSONP'</span><span class="token punctuation">,</span>
        desc<span class="token operator">:</span> <span class="token string">'by callback function'</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// callback函数调用data</span>
    <span class="token keyword">const</span> str <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fun<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span>

    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>


app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Server running at loaclhost:3000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>客户端发送JSONP跨域请求</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// JSONP跨域请求</span>
<span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'#jsonp'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  
  $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token operator">:</span><span class="token string">'GET'</span><span class="token punctuation">,</span>
    url<span class="token operator">:</span> <span class="token string">'http://127.0.0.1:3000/api/jsonp'</span><span class="token punctuation">,</span>
    dataType<span class="token operator">:</span> <span class="token string">'jsonp'</span><span class="token punctuation">,</span>
    <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="模版引擎-express-art-template"><a href="#模版引擎-express-art-template" class="header-anchor">#</a> 模版引擎 express-art-template</h2> <h3 id="基础设置"><a href="#基础设置" class="header-anchor">#</a> 基础设置</h3> <p>以art-template为例子</p> <p>还需要下载转为express封装的 express-art-templat</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> i art-template express-art-template
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token comment">// 1.设置存放模版的目录</span>
app<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'views'</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'views'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// 2.设置模版的默认后缀</span>
app<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'view engine'</span><span class="token punctuation">,</span> <span class="token string">'art'</span><span class="token punctuation">)</span>

<span class="token comment">// 3.设置使用哪个模版引擎去渲染后缀为art模版</span>
app<span class="token punctuation">.</span><span class="token function">engine</span><span class="token punctuation">(</span><span class="token string">'art'</span><span class="token punctuation">,</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express-art-template'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token comment">// 4. 处理请求</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/home'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token comment">// 渲染模版</span>
  res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'home'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    msg<span class="token operator">:</span> <span class="token string">'要渲染的数据'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>


app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Running at localhost:3000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code>xxx
<span class="token operator">|</span><span class="token operator">-</span> <span class="token keyword">public</span>
<span class="token operator">|</span><span class="token operator">-</span> routes
<span class="token operator">|</span><span class="token operator">-</span> views
		<span class="token operator">|</span><span class="token operator">-</span> home<span class="token punctuation">.</span>art
<span class="token operator">|</span><span class="token operator">-</span> index<span class="token punctuation">.</span>js
</code></pre></div><div class="language-html extra-class"><pre class="language-html"><code><span class="token comment">&lt;!--home.art--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>
  {{msg}}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="app-locals对象"><a href="#app-locals对象" class="header-anchor">#</a> app.locals对象</h3> <p>不同模版中的若在相同数据的场合</p> <p>若在渲染模版时，在所有模版中都去查询相同的部分，会造成代码重复冗余</p> <p>可以通过将相同数据写在app.locals对象下的自定义属性只，</p> <p>只调用一次数据，就可以在所以模版中使用</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 模版引擎配置</span>
app<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'views'</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'views'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'view engine'</span><span class="token punctuation">,</span> <span class="token string">'art'</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">engine</span><span class="token punctuation">(</span><span class="token string">'art'</span><span class="token punctuation">,</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express-art-template'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// 相同数据</span>
app<span class="token punctuation">.</span>locals<span class="token punctuation">.</span>users <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
  	name<span class="token operator">:</span><span class="token string">'andy'</span><span class="token punctuation">,</span>
  	age<span class="token operator">:</span><span class="token number">28</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
  	name<span class="token operator">:</span><span class="token string">'tom'</span><span class="token punctuation">,</span>
  	age<span class="token operator">:</span><span class="token number">28</span>
	<span class="token punctuation">}</span>  
<span class="token punctuation">]</span>

<span class="token comment">// 处理请求</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/home'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token comment">// 渲染模版</span>
  res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'home'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>


app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Running at localhost:3000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-html extra-class"><pre class="language-html"><code><span class="token comment">&lt;!--home.art--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
  {{each users}}
  	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>
  			{{$valu.name}}
        {{$valu.age}}
  	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  {{/each}}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="模版中的外链资源路径"><a href="#模版中的外链资源路径" class="header-anchor">#</a> 模版中的外链资源路径</h3> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>stylesheet<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./common.css<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre></div><p>模版中的外链资源路径是相对路径，</p> <p>是相对于浏览器请求URL地址的</p> <p>需要改为绝对路径，避免出错</p> <p>模版中通过  <strong>/</strong> 表示绝对路径</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>stylesheet<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/静态资源目录下路径<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>stylesheet<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>./admin/common.css<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre></div><h2 id="密码加密-bcrypt"><a href="#密码加密-bcrypt" class="header-anchor">#</a> 密码加密 bcrypt</h2> <p>将明文密码HASH加密，并插入随机字符串增加破译难度</p> <ul><li>windows环境安装</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 1. 安装python</span>

<span class="token comment"># 2. node-gyp</span>
<span class="token function">npm</span> i -g node-gyp

<span class="token comment"># 3. if Windows System</span>
<span class="token function">npm</span> i -g windows-build-tools
</code></pre></div><h3 id="导入、加密"><a href="#导入、加密" class="header-anchor">#</a> 导入、加密</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 导入</span>
<span class="token keyword">const</span> bcrypt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'bcrypt'</span><span class="token punctuation">)</span>

<span class="token comment">// 生成随机字符串（Salt盐）</span>
<span class="token keyword">let</span> salt <span class="token operator">=</span> <span class="token keyword">await</span> bcrypt<span class="token punctuation">.</span><span class="token function">genSalt</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>

<span class="token comment">// 使用随机字符串加密密码</span>
<span class="token keyword">let</span> pass <span class="token operator">=</span> <span class="token keyword">await</span> bcrypt<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token string">'明文密码'</span><span class="token punctuation">,</span> salt<span class="token punctuation">)</span>
</code></pre></div><h3 id="密码比对"><a href="#密码比对" class="header-anchor">#</a> 密码比对</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> isEqual <span class="token operator">=</span> <span class="token keyword">await</span> bcrypt<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span><span class="token string">'明文密码'</span>，<span class="token string">'加密后密码'</span><span class="token punctuation">)</span>

<span class="token keyword">if</span><span class="token punctuation">(</span>isEqual<span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token string">'比对成功密码一致'</span>
<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token string">'比对失败密码不一致'</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="身份认证"><a href="#身份认证" class="header-anchor">#</a> 身份认证</h2> <p>相见笔记 <a href="https://github.com/BlaxBerry/StudyNotes/blob/master/%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1/%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81.md" target="_blank" rel="noopener noreferrer">身份认证<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <ul><li><p><strong>服务器端渲染</strong>的开发模式</p> <p>推荐 <strong>Session认证机制</strong></p></li> <li><p><strong>前后端分离</strong>的开发模式</p> <p>推荐 <strong>JWT认证机制</strong></p></li></ul> <h3 id="session认证"><a href="#session认证" class="header-anchor">#</a> Session认证</h3> <p>通过express-session中间件在项目中使用Session认证</p> <h4 id="_1-安装"><a href="#_1-安装" class="header-anchor">#</a> 1. 安装</h4> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> i express-session
</code></pre></div><h4 id="_2-导入-配置中间件"><a href="#_2-导入-配置中间件" class="header-anchor">#</a> 2. 导入+ 配置中间件</h4> <p>通过secret设置密钥，虽然客户端能查看Cookie但是没有密钥看到的是一堆加密字符串</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 导入</span>
<span class="token keyword">const</span> session <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express-session'</span><span class="token punctuation">)</span>

<span class="token comment">// 使用中间件</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// 设置密钥，任意字符串</span>
  secret<span class="token operator">:</span><span class="token string">'secret key'</span>
  resave<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  saveUninitialized<span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="_3-向session对象中存数据"><a href="#_3-向session对象中存数据" class="header-anchor">#</a> 3. 向Session对象中存数据</h4> <p>在express-session中间件配置成功后，</p> <p>可通过 <strong>req.session</strong> 访问使用session对象，</p> <p>并通过 <strong>req.session.自定义属性</strong> 来储存 <strong>用户信息和登陆状态</strong></p> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/post'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  <span class="token comment">// 储存用户信息</span>
  req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>userInfo <span class="token operator">=</span> req<span class="token punctuation">.</span>body
  <span class="token comment">// 储存用户登陆状态</span>
  req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>islogin <span class="token operator">=</span> <span class="token boolean">true</span>
  
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    status<span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
    msg<span class="token operator">:</span> <span class="token string">'登陆成功'</span><span class="token punctuation">,</span>
    data<span class="token operator">:</span> <span class="token punctuation">{</span>
      username<span class="token operator">:</span> req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>userInfo<span class="token punctuation">.</span>username<span class="token punctuation">,</span>
      email<span class="token operator">:</span> req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>userInfo<span class="token punctuation">.</span>email
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>再比如：链接了MongoDB的场合</p> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取请求参数</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> email<span class="token punctuation">,</span> password <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
  	<span class="token comment">// 判断登陆邮箱是否存在于数据库中</span>
    <span class="token keyword">let</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> email <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// bcrypt匹配加密后的密码</span>
        <span class="token keyword">const</span> isEqual <span class="token operator">=</span> <span class="token keyword">await</span> bcrypt<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> user<span class="token punctuation">.</span>password<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isEqual<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          
            <span class="token comment">// 储存登陆用户的信息到session中</span>
            req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>username <span class="token operator">=</span> user<span class="token punctuation">.</span>username
          
            res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'登陆成功'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'admin/error'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>msg<span class="token operator">:</span> <span class="token string">'密码错误'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'admin/error'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>msg<span class="token operator">:</span> <span class="token string">'该邮箱不存在'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="_4-检查cookie"><a href="#_4-检查cookie" class="header-anchor">#</a> 4. 检查Cookie</h4> <p>后面返回给浏览器的Cookie为加密字符串</p> <img src="https://pbs.twimg.com/media/E57DJOcVoAAnTJL?format=jpg&amp;name=medium" style="zoom:50%;"> <h4 id="_5-清空session"><a href="#_5-清空session" class="header-anchor">#</a> 5. 清空Session</h4> <p>比如用户退出登陆时，需要清空Session</p> <p>通过**req.sessino.destroy()**实现清空服务器保存的sessin信息</p> <p>清空的只是请求退出的当前用户的Session，不会清除其他人的</p> <p>如下：</p> <p>清除关于该用户的session和cookie，并且重定向回 login页面</p> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/logout'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// clear session</span>
    req<span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// clear cookie (express-session默认名)</span>
        res<span class="token punctuation">.</span><span class="token function">clearCookie</span><span class="token punctuation">(</span><span class="token string">'connect.sid'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 重定向</span>
        res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/admin/login'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="jwt认证"><a href="#jwt认证" class="header-anchor">#</a> JWT认证</h3> <p>安装</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> i jsonwebtoken express-jwt
</code></pre></div><ul><li><p>jsonwebtoken：用于生成JWT字符串</p></li> <li><p>express-jwt：用于将JWT字符串解析还原为JSON对象</p></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/vuepress-studynotes/assets/js/app.5828a084.js" defer></script><script src="/vuepress-studynotes/assets/js/2.d9925a17.js" defer></script><script src="/vuepress-studynotes/assets/js/19.cd17f587.js" defer></script>
  </body>
</html>
